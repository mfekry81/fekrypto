<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Market Signals Updater</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { color: #333; }
        p { margin: 5px 0; }
        .coin { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        .news-item { margin: 10px 0; }
    </style>
</head>
<body>
    <div id="header"></div>
    <div id="overview"></div>
    <div id="coins"></div>
    <div id="top3"></div>
    <div id="risk"></div>
    <div id="news"></div>
    <div id="sessions"></div>

    <script>
        async function loadData() {
            try {
                // Clear existing content
                document.getElementById('header').innerHTML = '';
                document.getElementById('overview').innerHTML = '';
                document.getElementById('coins').innerHTML = '';
                document.getElementById('top3').innerHTML = '';
                document.getElementById('risk').innerHTML = '';
                document.getElementById('news').innerHTML = '';
                document.getElementById('sessions').innerHTML = '';

                // Timestamp in AST
                const now = new Date().toLocaleString('en-US', { timeZone: 'Asia/Riyadh', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });

                // Fetch Fear & Greed Index
                const fngRes = await fetch('https://api.alternative.me/fng/?limit=1');
                const fngData = await fngRes.json();
                const fng = fngData.data[0].value;
                const fngClass = fngData.data[0].value_classification;

                // Header
                document.getElementById('header').innerHTML = `<h1>Date, Time (AST): ${now}</h1><h2>Fear & Greed Index: ${fng} (${fngClass})</h2>`;

                // Fetch global market data from CoinGecko
                const globalRes = await fetch('https://api.coingecko.com/api/v3/global');
                const globalData = await globalRes.json();
                const marketCap = globalData.data.total_market_cap.usd.toLocaleString();
                const volume24h = globalData.data.total_volume.usd.toLocaleString();
                const btcDom = globalData.data.market_cap_percentage.btc.toFixed(2);

                // Market Overview
                let overviewHtml = `<h2>Market Overview</h2><p>BTC Dominance: ${btcDom}%</p><p>Total Market Cap: $${marketCap}</p><p>24h Total Volume: $${volume24h}</p>`;
                document.getElementById('overview').innerHTML = overviewHtml;

                // Coins list (Binance symbols)
                const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT', 'ZECUSDT', 'SUIUSDT', 'AVAXUSDT', 'LTCUSDT', 'LINKUSDT', 'TAOUSDT', 'ONDOUSDT', 'WLDUSDT', 'ARBUSDT', 'SEIUSDT', 'RENDERUSDT', 'APTUSDT', 'TIAUSDT'];
                const coinNames = ['BTC', 'ETH', 'SOL', 'BNB', 'XRP', 'ZEC', 'SUI', 'AVAX', 'LTC', 'LINK', 'TAO', 'ONDO', 'WLD', 'ARB', 'SEI', 'RENDER', 'APT', 'TIA'];

                let coinAnalyses = [];

                for (let i = 0; i < symbols.length; i++) {
                    const symbol = symbols[i];
                    const name = coinNames[i];

                    // Fetch 24hr ticker from Binance
                    const tickerRes = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
                    const ticker = await tickerRes.json();
                    const current = parseFloat(ticker.lastPrice).toFixed(4);
                    const high = parseFloat(ticker.highPrice).toFixed(4);
                    const low = parseFloat(ticker.lowPrice).toFixed(4);
                    const change = parseFloat(ticker.priceChangePercent).toFixed(2);
                    const volume = parseFloat(ticker.volume).toLocaleString();

                    // Fetch klines for RSI (1d interval for swing trading, limit 15 for RSI14)
                    const klinesRes = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=15`);
                    const klines = await klinesRes.json();
                    const closes = klines.map(k => parseFloat(k[4]));
                    const rsi = calculateRSI(closes);

                    // Overbought/Oversold
                    let status = rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral';

                    // Direction
                    let direction = rsi < 30 ? 'LONG' : rsi > 70 ? 'SHORT' : 'WAIT';

                    // Skip if WAIT
                    if (direction === 'WAIT') {
                        direction = 'WAIT';
                        var entryZone = 'N/A';
                        var sl = 'N/A';
                        var tp1 = 'N/A';
                        var tp2 = 'N/A';
                        var tp3 = 'N/A';
                        var tp4 = 'N/A';
                        var leverage = 'N/A';
                        var confidence = 0;
                        var rr = 'N/A';
                        var reasoning = 'RSI is neutral, no clear signal.';
                    } else {
                        // Entry zone (1% around current)
                        const entryLow = (direction === 'LONG' ? parseFloat(current) * 0.99 : parseFloat(current) * 1.01).toFixed(4);
                        const entryHigh = (direction === 'LONG' ? parseFloat(current) * 1.01 : parseFloat(current) * 0.99).toFixed(4);
                        entryZone = `${entryLow} - ${entryHigh}`;

                        // Stop loss (5% beyond 24h low/high)
                        sl = (direction === 'LONG' ? parseFloat(low) * 0.95 : parseFloat(high) * 1.05).toFixed(4);

                        // Take profits (scalping/swing targets: 5-20%)
                        tp1 = (direction === 'LONG' ? parseFloat(current) * 1.05 : parseFloat(current) * 0.95).toFixed(4);
                        tp2 = (direction === 'LONG' ? parseFloat(current) * 1.10 : parseFloat(current) * 0.90).toFixed(4);
                        tp3 = (direction === 'LONG' ? parseFloat(current) * 1.15 : parseFloat(current) * 0.85).toFixed(4);
                        tp4 = (direction === 'LONG' ? parseFloat(current) * 1.20 : parseFloat(current) * 0.80).toFixed(4);

                        // Leverage (conservative 3x-10x, based on confidence)
                        leverage = Math.round(3 + (rsi < 30 || rsi > 70 ? 7 : 0));

                        // Confidence (higher when more extreme RSI)
                        confidence = direction === 'LONG' ? Math.round((30 - rsi) / 30 * 100) : Math.round((rsi - 70) / 30 * 100);
                        confidence = Math.max(0, Math.min(100, confidence));

                        // R/R (risk to TP4 reward)
                        const entryAvg = parseFloat(current);
                        const risk = direction === 'LONG' ? (entryAvg - sl) / entryAvg : (sl - entryAvg) / entryAvg;
                        const reward = direction === 'LONG' ? (parseFloat(tp4) - entryAvg) / entryAvg : (entryAvg - parseFloat(tp4)) / entryAvg;
                        rr = (reward / risk).toFixed(2);

                        // Reasoning
                        reasoning = `Based on RSI of ${rsi.toFixed(2)}, which indicates ${status} conditions. This suggests a ${direction} opportunity in the 1-4 week swing timeframe. Volume supports the move with ${volume} units traded in 24h.`;
                    }

                    // Volume profile/order flow (simple: surge if change >5% abs)
                    const volStatus = Math.abs(change) > 5 ? 'Volume Surge Detected' : 'Normal Volume';
                    const orderFlow = change > 0 ? 'Bullish Order Flow' : 'Bearish Order Flow';

                    // Coin HTML
                    const coinHtml = `
                        <div class="coin">
                            <h3>${name}</h3>
                            <p>Current Price: $${current}</p>
                            <p>24h Change: ${change}%</p>
                            <p>24h Volume: ${volume}</p>
                            <p>24h High: $${high}, Low: $${low}</p>
                            <p>Technical Analysis: RSI ${rsi.toFixed(2)}</p>
                            <p>Overbought/Oversold: ${status}</p>
                            <p>Volume Profile: ${volStatus}</p>
                            <p>Order Flow: ${orderFlow}</p>
                            <p>Volume Surges: ${volStatus}</p>
                            <p>Futures Trading Signal:</p>
                            <p>Direction: ${direction}</p>
                            <p>Entry Zone: ${entryZone}</p>
                            <p>Stop Loss: ${sl}</p>
                            <p>Take Profit Targets: TP1 ${tp1} (25%), TP2 ${tp2} (30%), TP3 ${tp3} (25%), TP4 ${tp4} (20%)</p>
                            <p>Recommended Leverage: ${leverage}x</p>
                            <p>Confidence Level: ${confidence}%</p>
                            <p>Risk/Reward Ratio: ${rr}</p>
                            <p>Detailed Reasoning: ${reasoning}</p>
                        </div>
                    `;
                    document.getElementById('coins').innerHTML += coinHtml;

                    // Store for top 3
                    coinAnalyses.push({ name, direction, confidence, reasoning });
                }

                // Top 3 Priority Trades (sorted by confidence)
                coinAnalyses = coinAnalyses.filter(c => c.direction !== 'WAIT');
                coinAnalyses.sort((a, b) => b.confidence - a.confidence);
                const top3 = coinAnalyses.slice(0, 3);
                let top3Html = '<h2>Top 3 Priority Trades</h2>';
                top3.forEach((trade, index) => {
                    top3Html += `<p>${index + 1}. ${trade.name} - ${trade.direction} (Confidence: ${trade.confidence}%) - ${trade.reasoning}</p>`;
                });
                document.getElementById('top3').innerHTML = top3Html;

                // Risk Management Guidelines based on F&G
                let capitalDeploy;
                if (fng <= 25) capitalDeploy = '40-50% (Extreme Fear - Maximum contrarian buy)';
                else if (fng <= 45) capitalDeploy = '55-65% (Fear - Gradual accumulation)';
                else if (fng <= 55) capitalDeploy = '75-90% (Neutral - Balanced approach)';
                else if (fng <= 75) capitalDeploy = '40-50% (Greed - Take profits)';
                else capitalDeploy = '20-30% (Extreme Greed - Heavy selling)';
                const riskHtml = `<h2>Risk Management Guidelines</h2><p>Deploy ${capitalDeploy} of capital based on Fear & Greed Index.</p><p>Always use stop losses 5-15% from entry. Position size per trade: 1-5% of deployed capital. Monitor leverage to avoid liquidation.</p>`;
                document.getElementById('risk').innerHTML = riskHtml;

                // Market News (from CryptoPanic API)
                const newsRes = await fetch('https://cryptopanic.com/api/v1/posts/?currencies=BTC,ETH,SOL,BNB,XRP&regions=en&kind=news&filter=hot&public=true');
                const newsData = await newsRes.json();
                let newsHtml = '<h2>Market News</h2>';
                newsData.results.slice(0, 5).forEach(item => {
                    newsHtml += `<div class="news-item"><a href="${item.url}" target="_blank">${item.title}</a> (${item.published_at})</div>`;
                });
                document.getElementById('news').innerHTML = newsHtml;

                // Market Sessions (approximate global sessions affecting crypto)
                const hour = new Date().getUTCHours() + 3; // AST is UTC+3
                let session;
                if (hour >= 0 && hour < 8) session = 'Asian Session (Active)';
                else if (hour >= 8 && hour < 13) session = 'European Session (Active)';
                else session = 'US Session (Active)';
                document.getElementById('sessions').innerHTML = `<h2>Market Sessions</h2><p>Current Session: ${session}. Crypto markets are 24/7, but traditional market overlaps (e.g., US open) can increase volatility.</p>`;

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('header').innerHTML = '<p>Error loading data. Please refresh.</p>';
            }
        }

        function calculateRSI(closes) {
            if (closes.length < 15) return 50;
            let gains = 0;
            let losses = 0;
            for (let i = 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i - 1];
                if (diff > 0) gains += diff;
                else losses += Math.abs(diff);
            }
            gains /= 14;
            losses /= 14;
            if (losses === 0) return 100;
            if (gains === 0) return 0;
            const rs = gains / losses;
            return 100 - (100 / (1 + rs));
        }

        // Initial load
        loadData();

        // Update every 5 minutes
        setInterval(loadData, 300000);
    </script>
</body>
</html>